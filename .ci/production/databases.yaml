AWSTemplateFormatVersion: 2010-09-09
Description: Solidvessel Databases
Resources:
  AccountDB:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      DBInstanceIdentifier: solidvessel-account-db
      DBInstanceClass: db.t4g.medium
      DBSubnetGroupName: !Ref K8SSubnetGroup
      AllocatedStorage: 20
      Engine: postgres
      EngineVersion: "16.4"
      DBSnapshotIdentifier: solidvessel-databases-snapshot-accountdb-kmdeh5lrckwz
      DBSecurityGroups:
      - Ref: DBSecurityGroup
  InventoryDB:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      DBInstanceIdentifier: solidvessel-inventory-db
      DBInstanceClass: db.t4g.medium
      DBSubnetGroupName: !Ref K8SSubnetGroup
      AllocatedStorage: 20
      Engine: postgres
      EngineVersion: "16.4"
      DBSnapshotIdentifier: solidvessel-databases-snapshot-inventorydb-opf2kfvocqrf
      DBSecurityGroups:
      - Ref: DBSecurityGroup
  OrderDB:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      DBInstanceIdentifier: solidvessel-order-db
      DBInstanceClass: db.t4g.medium
      DBSubnetGroupName: !Ref K8SSubnetGroup
      AllocatedStorage: 20
      Engine: postgres
      EngineVersion: "16.4"
      DBSnapshotIdentifier: solidvessel-databases-snapshot-orderdb-usgtmpuqn5fw
      DBSecurityGroups:
      - Ref: DBSecurityGroup
  PaymentDB:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      DBInstanceIdentifier: solidvessel-payment-db
      DBInstanceClass: db.t4g.medium
      DBSubnetGroupName: !Ref K8SSubnetGroup
      AllocatedStorage: 20
      Engine: postgres
      EngineVersion: "16.4"
      DBSnapshotIdentifier: solidvessel-databases-snapshot-paymentdb-umpczzspq9f7
      DBSecurityGroups:
      - Ref: DBSecurityGroup
  KeycloakDB:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      DBInstanceIdentifier: solidvessel-keycloak-db
      DBInstanceClass: db.t4g.medium
      DBSubnetGroupName: !Ref K8SSubnetGroup
      AllocatedStorage: 20
      Engine: postgres
      EngineVersion: "16.4"
      DBSnapshotIdentifier: solidvessel-databases-snapshot-keycloakdb-xf2sjwcuamhd
      DBSecurityGroups:
      - Ref: DBSecurityGroup
  K8SSubnetGroup:
    Type: "AWS::RDS::DBSubnetGroup"
    Properties:
      DBSubnetGroupDescription: Databases should be in the same VPC with the K8S cluster
      SubnetIds:
        !Split [ ",", !ImportValue eksctl-solidvessel-cluster::SubnetsPrivate ]
  DBSecurityGroup:
    Type: 'AWS::RDS::DBSecurityGroup'
    Properties:
      DBSecurityGroupIngress:
      - EC2SecurityGroupId: !Ref EC2SecurityGroup
      EC2VpcId: !ImportValue eksctl-solidvessel-cluster::VPC
  EC2SecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow DB connection from EC2
      GroupName: rds-sg
      SecurityGroupIngress:
        FromPort: 5432
        ToPort: 5432
        IpProtocol: tcp
        SourceSecurityGroupId: !ImportValue eksctl-solidvessel-cluster::ClusterSecurityGroupId
      VpcId: !ImportValue eksctl-solidvessel-cluster::VPC
